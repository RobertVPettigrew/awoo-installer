name: Manual Build & Upload Artifact

on:
  workflow_dispatch:
    inputs:
      publish:
        description: 'Also publish to gh-pages (true/false)'
        required: false
        default: 'false'
      artifact_name:
        description: 'Optional artifact name to force'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.package.outputs.artifact-name }}
      artifact-path: ${{ steps.package.outputs.artifact-path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build default target (produce .nro)
        id: buildstep-nro
        run: |
          docker run --rm -v "${{ github.workspace }}":/work -w /work devkitpro/devkita64:latest \
            bash -lc "set -e && \
            apt-get update && apt-get install -y pkg-config libcurl4-openssl-dev libsdl2-dev libturbojpeg-dev libfreetype6-dev zlib1g-dev libjpeg-dev libwebp-dev libopus-dev libmpg123-dev libmodplug-dev || true && \
            make clean || true && \
            make -j\$(nproc)"

      - name: Build NSP (if config.json exists)
        id: buildstep-nsp
        run: |
          # If a config JSON is present at repo root, build an NSP using that JSON
          if [ -f config.json ]; then
            echo "config.json found, attempting NSP build..."
            docker run --rm -v "${{ github.workspace }}":/work -w /work devkitpro/devkita64:latest \
              bash -lc "set -e && \
              apt-get update && apt-get install -y pkg-config libcurl4-openssl-dev libsdl2-dev libturbojpeg-dev libfreetype6-dev zlib1g-dev libjpeg-dev libwebp-dev libopus-dev libmpg123-dev libmodplug-dev || true && \
              make clean || true && \
              make APP_JSON=config.json -j\$(nproc) || true"
          else
            echo "config.json not found, skipping NSP build."
          fi

      - name: Locate artifact
        id: package
        run: |
          mkdir -p release_artifacts
          ART=""
          # prefer explicit artifact name if passed
          if [ -n "${{ github.event.inputs.artifact_name }}" ]; then
            if [ -f "${{ github.event.inputs.artifact_name }}" ]; then
              cp "${{ github.event.inputs.artifact_name }}" release_artifacts/
              ART="${{ github.event.inputs.artifact_name }}"
            fi
          fi

          # collect common output files, prefer .nsp and .nro
          for f in *.nsp *.nro *.elf *.xci *.zip; do
            if [ -f "$f" ]; then
              cp -n "$f" release_artifacts/ || true
              if [ -z "$ART" ]; then
                ART="$f"
              fi
            fi
          done

          # fallback: include build directory
          if [ -z "$ART" ]; then
            cp -r build release_artifacts/ 2>/dev/null || true
            zip -r release_artifacts/awoo-installer-build-${{ github.run_id }}.zip build || true
            ART="awoo-installer-build-${{ github.run_id }}.zip"
            cp release_artifacts/*.zip . || true
          fi

          if [ -z "$ART" ]; then
            echo "No artifact found" >&2
            exit 1
          fi

          echo "artifact-path=release_artifacts/$ART" >> $GITHUB_OUTPUT
          echo "artifact-name=$ART" >> $GITHUB_OUTPUT
          ls -la release_artifacts || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: release_artifacts/
          if-no-files-found: error

      - name: Optional: publish to gh-pages
        if: ${{ github.event.inputs.publish == 'true' }}
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./release_artifacts
          destination_dir: dev/${{ github.run_id }}
