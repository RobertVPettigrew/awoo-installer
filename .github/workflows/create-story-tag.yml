name: Create Story Tag

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to create tag for (optional - required for manual run)'
        required: false
        type: number
      branch:
        description: 'Branch to point the tag at (optional)'
        required: false
        default: 'copilot/fix-address-space-type-issue'
      title:
        description: 'Optional title override for slug generation'
        required: false

jobs:
  create-tag:
    name: Create alpha tag from story
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Create tag ref for story
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const core = require('@actions/core');
            const github = require('@actions/github');
            const context = github.context;
            const inputs = (context.payload && context.payload.inputs) || {};
            const issueFromEvent = context.payload.issue;
            const issueNumber = issueFromEvent ? issueFromEvent.number : (inputs.issue_number ? Number(inputs.issue_number) : null);
            const isLabelEvent = context.eventName === 'issues' && context.payload.action === 'labeled';
            if (isLabelEvent) {
              const labelName = context.payload.label && context.payload.label.name;
              if (labelName !== 'release') {
                core.info(`Issue labeled '${labelName}'; not creating tag (requires label 'release').`);
                return;
              }
            }
            if (!issueNumber) {
              core.setFailed('No issue number provided. For manual runs, pass issue_number. For labeled events, label an issue.');
              return;
            }
            const title = issueFromEvent ? issueFromEvent.title : (inputs.title || 'no-title');
            const slugify = s => (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,50);
            const slug = slugify(title);
            const tag = `alpha-ISSUE-${issueNumber}-${slug}`;

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = (inputs.branch) || 'copilot/fix-address-space-type-issue';

            core.info(`Creating tag ${tag} pointing at branch ${branch} in ${owner}/${repo}`);

            (async () => {
              try {
                const branchRef = await github.getOctokit(core.getInput('github-token') || process.env.GITHUB_TOKEN).rest.git.getRef({ owner, repo, ref: `heads/${branch}` });
                const sha = branchRef.data.object.sha;

                try {
                  await github.getOctokit(core.getInput('github-token') || process.env.GITHUB_TOKEN).rest.git.createRef({ owner, repo, ref: `refs/tags/${tag}`, sha });
                  core.info(`Tag refs/tags/${tag} created -> ${sha}`);
                } catch (err) {
                  if (err.status === 422 && err.message && err.message.includes('Reference already exists')) {
                    core.info(`Tag refs/tags/${tag} already exists. Skipping.`);
                  } else {
                    throw err;
                  }
                }
              } catch (err) {
                if (err.status === 404) {
                  core.setFailed(`Branch ${branch} not found in repository.`);
                } else {
                  core.setFailed(err.message || String(err));
                }
              }
            })();
